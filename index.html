import logging
import json
import os
from aiogram import Bot, Dispatcher, types
from aiogram.utils import executor
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup

# ====== НАСТРОЙКИ ======
BOT_TOKEN = "ВАШ_ТОКЕН_ОТ_BOTFATHER"  # <-- Замените на свой токен
DB_FILE = "users_db.json"            # Файл для хранения данных

# ====== ЛОГИРОВАНИЕ ======
logging.basicConfig(level=logging.INFO)

# ====== ИНИЦИАЛИЗАЦИЯ БОТА ======
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot, storage=MemoryStorage())

# ====== СОСТОЯНИЯ (FSM) ======
class RegistrationStates(StatesGroup):
    waiting_for_code = State()

class GenerationStates(StatesGroup):
    waiting_for_image_prompt = State()
    waiting_for_text_prompt = State()

# ====== ФУНКЦИИ РАБОТЫ С "БАЗОЙ" (JSON) ======
def load_db():
    """Загружает базу пользователей из JSON."""
    if not os.path.exists(DB_FILE):
        return {}
    with open(DB_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

def save_db(db_data):
    """Сохраняет базу пользователей в JSON."""
    with open(DB_FILE, "w", encoding="utf-8") as f:
        json.dump(db_data, f, ensure_ascii=False, indent=2)

def get_user_data(user_id):
    """Получает запись о пользователе из базы по user_id."""
    db_data = load_db()
    return db_data.get(str(user_id), None)

def set_user_data(user_id, data):
    """Сохраняет/обновляет запись пользователя в базе."""
    db_data = load_db()
    db_data[str(user_id)] = data
    save_db(db_data)

# ====== /START ======
@dp.message_handler(commands=['start'])
async def cmd_start(message: types.Message):
    user_id = message.from_user.id
    user_data = get_user_data(user_id)

    # Если пользователь уже есть в базе, приветствуем и показываем меню
    if user_data:
        await message.answer(
            "С возвращением! Вы уже зарегистрированы.\n"
            "Выберите команду:\n"
            "/generate_image – Сгенерировать изображение\n"
            "/generate_text – Сгенерировать текст\n"
            "/help – Справка"
        )
    else:
        # Предлагаем зарегистрироваться
        await message.answer(
            "Добро пожаловать в мини-бот AiBorn!\n"
            "Чтобы продолжить, введите любой 'код' (придумайте сами) для регистрации.\n"
            "Например: 12345 или любое другое слово."
        )
        await RegistrationStates.waiting_for_code.set()

# ====== РЕГИСТРАЦИЯ ======
@dp.message_handler(state=RegistrationStates.waiting_for_code, content_types=types.ContentTypes.TEXT)
async def process_registration_code(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    code = message.text.strip()

    # Создаём новую запись в "базе"
    new_user_data = {
        "user_id": user_id,
        "registration_code": code,
        # Допустим, дадим лимит 5 генераций изображений, 10 текстов
        "image_limit": 5,
        "text_limit": 10,
    }
    set_user_data(user_id, new_user_data)

    await message.answer(
        f"Отлично! Вы зарегистрированы.\n"
        f"Ваш 'код': {code}\n\n"
        "Что будем делать?\n"
        "/generate_image – Сгенерировать изображение\n"
        "/generate_text – Сгенерировать текст\n"
        "/help – Справка"
    )
    await state.finish()

# ====== ГЕНЕРАЦИЯ ИЗОБРАЖЕНИЙ ======
@dp.message_handler(commands=['generate_image'])
async def cmd_generate_image(message: types.Message):
    user_id = message.from_user.id
    user_data = get_user_data(user_id)

    # Проверяем, есть ли пользователь в базе
    if not user_data:
        await message.answer("Вы не зарегистрированы. Наберите /start для регистрации.")
        return

    # Проверяем лимит
    if user_data.get("image_limit", 0) <= 0:
        await message.answer("У вас закончились лимиты на генерацию изображений.")
        return

    await message.answer("Пришлите описание (prompt) для изображения.")
    await GenerationStates.waiting_for_image_prompt.set()

@dp.message_handler(state=GenerationStates.waiting_for_image_prompt, content_types=types.ContentTypes.TEXT)
async def process_image_prompt(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    prompt = message.text.strip()
    user_data = get_user_data(user_id)

    # (Здесь должна быть реальная генерация через API или локальную модель)
    # Для демонстрации отправим "заглушку"
    await message.answer(f"Генерирую изображение по описанию: {prompt}\n(Демо)")

    # Допустим, мы «сгенерировали» и отправим фото (заглушка — тот же текст)
    # В реальном коде вы подставите реальный файл или ссылку
    await message.answer("Вот сгенерированное изображение (на самом деле, заглушка).")

    # Списываем 1 лимит у пользователя
    current_limit = user_data.get("image_limit", 0)
    user_data["image_limit"] = current_limit - 1
    set_user_data(user_id, user_data)

    await message.answer(f"Осталось генераций изображений: {user_data['image_limit']}")
    await state.finish()

# ====== ГЕНЕРАЦИЯ ТЕКСТА ======
@dp.message_handler(commands=['generate_text'])
async def cmd_generate_text(message: types.Message):
    user_id = message.from_user.id
    user_data = get_user_data(user_id)
    if not user_data:
        await message.answer("Вы не зарегистрированы. Наберите /start для регистрации.")
        return

    if user_data.get("text_limit", 0) <= 0:
        await message.answer("У вас закончились лимиты на генерацию текста.")
        return

    await message.answer("Пришлите задание (prompt) для генерации текста.")
    await GenerationStates.waiting_for_text_prompt.set()

@dp.message_handler(state=GenerationStates.waiting_for_text_prompt, content_types=types.ContentTypes.TEXT)
async def process_text_prompt(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    prompt = message.text.strip()
    user_data = get_user_data(user_id)

    # Здесь должна быть реальная генерация текста (например, API OpenAI ChatGPT).
    # В демо-версии просто ответим "заглушкой".
    generated_text = f"Сгенерированный текст по запросу '{prompt}': (демо-текст)"
    await message.answer(generated_text)

    # Списываем 1 лимит
    current_limit = user_data.get("text_limit", 0)
    user_data["text_limit"] = current_limit - 1
    set_user_data(user_id, user_data)

    await message.answer(f"Осталось генераций текста: {user_data['text_limit']}")
    await state.finish()

# ====== СПРАВКА ======
@dp.message_handler(commands=['help'])
async def cmd_help(message: types.Message):
    await message.answer(
        "Доступные команды:\n"
        "/start – Регистрация (если ещё не)\n"
        "/generate_image – Генерация изображения\n"
        "/generate_text – Генерация текста\n"
        "/help – Справка\n\n"
        "Лимиты на генерацию устанавливаются при регистрации. \n"
        "В данном демо-боте всё хранится в файле users_db.json."
    )

# ====== НЕОБРАБОТАННЫЕ СООБЩЕНИЯ ======
@dp.message_handler()
async def default_handler(message: types.Message):
    await message.answer("Неизвестная команда. Воспользуйтесь /help.")

# ====== ЗАПУСК ======
if __name__ == "__main__":
    # Для запуска: python aiborn_mini_app.py
    executor.start_polling(dp, skip_updates=True)
